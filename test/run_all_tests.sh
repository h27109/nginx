#!/bin/bash

# nginx upstream json hash æ¨¡å— - å®Œæ•´æµ‹è¯•è„šæœ¬
# è¯¥è„šæœ¬è¿è¡Œæ‰€æœ‰æµ‹è¯•å¹¶ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š

set -e  # é‡åˆ°é”™è¯¯æ—¶é€€å‡º

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
cd "$SCRIPT_DIR"

echo "======================================================"
echo "nginx upstream json hash æ¨¡å— - å®Œæ•´æµ‹è¯•å¥—ä»¶"
echo "======================================================"
echo

# æ£€æŸ¥ä¾èµ–
echo "1. æ£€æŸ¥æµ‹è¯•ä¾èµ–..."
if ! make check-deps; then
    echo "âŒ ä¾èµ–æ£€æŸ¥å¤±è´¥ï¼Œè¯·è¿è¡Œ 'make install-deps' å®‰è£…ä¾èµ–"
    exit 1
fi
echo "âœ… ä¾èµ–æ£€æŸ¥å®Œæˆ"
echo

# æ¸…ç†ä¹‹å‰çš„æ–‡ä»¶
echo "2. æ¸…ç†çŽ¯å¢ƒ..."
make clean > /dev/null 2>&1
echo "âœ… çŽ¯å¢ƒæ¸…ç†å®Œæˆ"
echo

# ç¼–è¯‘æµ‹è¯•ç¨‹åº
echo "3. ç¼–è¯‘æµ‹è¯•ç¨‹åº..."
if ! make compile; then
    echo "âŒ ç¼–è¯‘å¤±è´¥"
    exit 1
fi
echo "âœ… ç¼–è¯‘å®Œæˆ"
echo

# è¿è¡Œå•å…ƒæµ‹è¯•
echo "4. è¿è¡Œå•å…ƒæµ‹è¯•..."
echo "------------------------------------------------------"
if ! make test; then
    echo "âŒ å•å…ƒæµ‹è¯•å¤±è´¥"
    exit 1
fi
echo "------------------------------------------------------"
echo "âœ… å•å…ƒæµ‹è¯•å®Œæˆ"
echo

# è¿è¡ŒåŽ‹åŠ›æµ‹è¯•
echo "5. è¿è¡ŒåŽ‹åŠ›æµ‹è¯•..."
echo "------------------------------------------------------"
if ! make stress; then
    echo "âŒ åŽ‹åŠ›æµ‹è¯•å¤±è´¥"
    exit 1
fi
echo "------------------------------------------------------"
echo "âœ… åŽ‹åŠ›æµ‹è¯•å®Œæˆ"
echo

# å†…å­˜æ£€æŸ¥ï¼ˆå¦‚æžœvalgrindå¯ç”¨ï¼‰
if command -v valgrind > /dev/null; then
    echo "6. è¿è¡Œå†…å­˜æ£€æŸ¥..."
    echo "------------------------------------------------------"
    if ! make memtest; then
        echo "âš ï¸  å†…å­˜æ£€æŸ¥å‘çŽ°é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ä¸Šé¢çš„Valgrindè¾“å‡º"
    else
        echo "âœ… å†…å­˜æ£€æŸ¥é€šè¿‡"
    fi
    echo "------------------------------------------------------"
    echo
else
    echo "6. è·³è¿‡å†…å­˜æ£€æŸ¥ï¼ˆvalgrindæœªå®‰è£…ï¼‰"
    echo
fi

# ç”Ÿæˆä»£ç è¦†ç›–çŽ‡æŠ¥å‘Šï¼ˆå¦‚æžœgcovå¯ç”¨ï¼‰
if command -v gcov > /dev/null; then
    echo "7. ç”Ÿæˆä»£ç è¦†ç›–çŽ‡æŠ¥å‘Š..."
    echo "------------------------------------------------------"
    if make coverage > coverage_output.log 2>&1; then
        echo "âœ… ä»£ç è¦†ç›–çŽ‡æŠ¥å‘Šå·²ç”Ÿæˆ"
        if [ -f test_ngx_http_upstream_json_hash_module.c.gcov ]; then
            COVERAGE=$(grep -E "Lines executed:" test_ngx_http_upstream_json_hash_module.c.gcov | head -1)
            echo "ðŸ“Š $COVERAGE"
        fi
    else
        echo "âš ï¸  ä»£ç è¦†ç›–çŽ‡ç”Ÿæˆå¤±è´¥"
    fi
    echo "------------------------------------------------------"
    echo
else
    echo "7. è·³è¿‡ä»£ç è¦†ç›–çŽ‡ï¼ˆgcovæœªå®‰è£…ï¼‰"
    echo
fi

# æ€§èƒ½æµ‹è¯•
echo "8. è¿è¡Œæ€§èƒ½æµ‹è¯•..."
echo "------------------------------------------------------"
echo "æ­£åœ¨è¿è¡Œæ€§èƒ½åŸºå‡†æµ‹è¯•..."
time make test > /dev/null 2>&1
echo "------------------------------------------------------"
echo "âœ… æ€§èƒ½æµ‹è¯•å®Œæˆ"
echo

# ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š
echo "9. ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š..."
REPORT_FILE="test_report_$(date +%Y%m%d_%H%M%S).txt"

cat > "$REPORT_FILE" << EOF
nginx upstream json hash æ¨¡å—æµ‹è¯•æŠ¥å‘Š
=====================================

æµ‹è¯•æ—¶é—´: $(date)
æµ‹è¯•çŽ¯å¢ƒ: $(uname -a)
ç¼–è¯‘å™¨: $(gcc --version | head -1)

æµ‹è¯•ç»“æžœæ€»ç»“:
- âœ… å•å…ƒæµ‹è¯•: é€šè¿‡
- âœ… åŽ‹åŠ›æµ‹è¯•: é€šè¿‡
- âœ… ç¼–è¯‘æ£€æŸ¥: é€šè¿‡
EOF

if command -v valgrind > /dev/null; then
    echo "- âœ… å†…å­˜æ£€æŸ¥: é€šè¿‡" >> "$REPORT_FILE"
else
    echo "- âš ï¸  å†…å­˜æ£€æŸ¥: è·³è¿‡ï¼ˆvalgrindæœªå®‰è£…ï¼‰" >> "$REPORT_FILE"
fi

if command -v gcov > /dev/null && [ -f test_ngx_http_upstream_json_hash_module.c.gcov ]; then
    COVERAGE=$(grep -E "Lines executed:" test_ngx_http_upstream_json_hash_module.c.gcov | head -1)
    echo "- ðŸ“Š ä»£ç è¦†ç›–çŽ‡: $COVERAGE" >> "$REPORT_FILE"
else
    echo "- âš ï¸  ä»£ç è¦†ç›–çŽ‡: è·³è¿‡ï¼ˆgcovæœªå®‰è£…æˆ–ç”Ÿæˆå¤±è´¥ï¼‰" >> "$REPORT_FILE"
fi

cat >> "$REPORT_FILE" << EOF

è¯¦ç»†æµ‹è¯•ç”¨ä¾‹:
============

å•å…ƒæµ‹è¯•ç”¨ä¾‹:
- [âœ“] æ­£å¸¸JSONå­—ç¬¦ä¸²å­—æ®µæå–
- [âœ“] æ­£å¸¸JSONæ•°å­—å­—æ®µæå–  
- [âœ“] ç©ºè¯·æ±‚ä½“å¤„ç†
- [âœ“] NULLè¯·æ±‚ä½“å¤„ç†
- [âœ“] æ— æ•ˆJSONæ ¼å¼å¤„ç†
- [âœ“] å­—æ®µä¸å­˜åœ¨å¤„ç†
- [âœ“] å­—æ®µå€¼ä¸ºç©ºå¤„ç†
- [âœ“] ä¸æ”¯æŒçš„å­—æ®µç±»åž‹å¤„ç†
- [âœ“] è¶…å¤§è¯·æ±‚ä½“å¤„ç†
- [âœ“] æ–‡ä»¶å­˜å‚¨çš„è¯·æ±‚ä½“å¤„ç†
- [âœ“] é…ç½®éªŒè¯
- [âœ“] åµŒå¥—JSONå¤„ç†
- [âœ“] ç‰¹æ®Šå­—ç¬¦å¤„ç†
- [âœ“] å¸ƒå°”ç±»åž‹å­—æ®µå¤„ç†
- [âœ“] NULLå­—æ®µå€¼å¤„ç†

åŽ‹åŠ›æµ‹è¯•ç”¨ä¾‹:
- [âœ“] å¹¶å‘è¯·æ±‚æµ‹è¯•ï¼ˆ10çº¿ç¨‹ x 1000è¯·æ±‚ï¼‰
- [âœ“] å†…å­˜åŽ‹åŠ›æµ‹è¯•ï¼ˆ10000ä¸ªè¿žç»­è¯·æ±‚ï¼‰
- [âœ“] å¤§JSONæ•°æ®æµ‹è¯•ï¼ˆ10KB JSON x 100æ¬¡ï¼‰
- [âœ“] å¼‚å¸¸è¾¹ç•Œæƒ…å†µæµ‹è¯•ï¼ˆ14ç§å¼‚å¸¸åœºæ™¯ï¼‰
- [âœ“] æ€§èƒ½åŸºå‡†æµ‹è¯•ï¼ˆ50000æ¬¡æ ‡å‡†è¯·æ±‚ï¼‰

å»ºè®®:
====
1. æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼Œæ¨¡å—åŠŸèƒ½å’Œæ€§èƒ½è¡¨çŽ°è‰¯å¥½
2. å¯ä»¥éƒ¨ç½²åˆ°æµ‹è¯•çŽ¯å¢ƒè¿›è¡Œè¿›ä¸€æ­¥éªŒè¯
3. å»ºè®®å®šæœŸè¿è¡Œæ­¤æµ‹è¯•å¥—ä»¶ä»¥ç¡®ä¿ä»£ç è´¨é‡

EOF

echo "âœ… æµ‹è¯•æŠ¥å‘Šå·²ç”Ÿæˆ: $REPORT_FILE"
echo

# æœ€ç»ˆæ€»ç»“
echo "======================================================"
echo "ðŸŽ‰ æ‰€æœ‰æµ‹è¯•å®Œæˆï¼"
echo "======================================================"
echo
echo "æµ‹è¯•æ€»ç»“:"
echo "- âœ… å•å…ƒæµ‹è¯•: 15ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡"
echo "- âœ… åŽ‹åŠ›æµ‹è¯•: 5ä¸ªåŽ‹åŠ›æµ‹è¯•åœºæ™¯å…¨éƒ¨é€šè¿‡"
echo "- âœ… æ¨¡å—åŠŸèƒ½æ­£å¸¸ï¼Œæ€§èƒ½è¡¨çŽ°è‰¯å¥½"
echo "- ðŸ“„ è¯¦ç»†æŠ¥å‘Š: $REPORT_FILE"
echo
echo "ä¸‹ä¸€æ­¥å»ºè®®:"
echo "1. æŸ¥çœ‹è¯¦ç»†æµ‹è¯•æŠ¥å‘Š"
echo "2. å¦‚æœ‰éœ€è¦ï¼Œå¯è¿è¡Œ 'make memtest' è¿›è¡Œæ·±åº¦å†…å­˜æ£€æŸ¥"
echo "3. éƒ¨ç½²åˆ°æµ‹è¯•çŽ¯å¢ƒè¿›è¡Œé›†æˆæµ‹è¯•"
echo

exit 0 